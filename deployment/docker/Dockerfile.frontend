# Multi-stage build: Stage 1 - Build
FROM maven:3.8.6-openjdk-17 AS build
WORKDIR /app
COPY . .  # Copy entire project

# Build common module first (dependency)
WORKDIR /app/ShopMeCommon
RUN mvn clean install -DskipTests

# Build frontend module
WORKDIR /app/ShopMeWebParent/ShopMeFrontEnd
RUN mvn clean package -DskipTests

# Multi-stage build: Stage 2 - Run (smaller image)
FROM openjdk:17-jdk-slim
WORKDIR /app

# Copy built JAR from build stage
COPY --from=build /app/ShopMeWebParent/ShopMeFrontEnd/target/*.jar app.jar

# Expose port
EXPOSE 8081

# Run with production profile
ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]